<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Saif</title>
    <script src="./js/peerjs.min.js"></script>
</head>
<body>
    <h3>Peer ID : <span id="peerIdWrapper"></span></h3>
    <input type="text" placeholder="Partner Peer ID" id="peerIdInputField">
    <input type="button" value="Connect" id="peerConnectionButton">
    <h5>Connection Status : <span id="connectionStatus">.......</span></h5>

    <button id="callButton">Video Call</button>
    <button id="receiveButton">Receive Call</button>

    <br><br>

    <div style="position: relative; width: 100%; max-width: 500px;">
        <video muted id="sender" style="position: absolute; left: 0; top: 0; width: 25%; z-index: 20;"></video>
        <video id="receiver" style="position: absolute; left: 0; right: 0; top: 0; bottom: 0; width: 100%; z-index: 10;"></video>
    </div>

    <script>
        const STUNServer = "stun:stun.l.google.com:19302";
        const TURNServer = "turn:numb.viagenic.ca";
        const serverPassword = "uscAgMf8vg7VAut";
        const serverUserName = "rabbillDLC@gmail.com";

        const serverConfig = {
            config: {
                'iceServers': [
                    { url: STUNServer },
                    { url: TURNServer, credential: serverPassword, username: serverUserName }
                ]
            }
        }

        const peer = new Peer(serverConfig);
        
        const peerIdWrapper = document.getElementById("peerIdWrapper");
        const peerIdInputField = document.getElementById("peerIdInputField");
        const peerConnectionButton = document.getElementById("peerConnectionButton");
        const connectionStatus = document.getElementById("connectionStatus");
        const callButton = document.getElementById("callButton");
        const receiveButton = document.getElementById("receiveButton");
        const sender = document.getElementById("sender");
        const receiver = document.getElementById("receiver");

        const mediaPermission = {
            'video': true,
            'audio': true
        };

        peer.on("open", (peerId) => {
            peerIdWrapper.innerHTML = peerId;
        });

        peerConnectionButton.onclick = () => {
            connectionStatus.innerHTML = ".......";
            
            let partnerPeerId = peerIdInputField.value.trim();

            let connection = peer.connect(partnerPeerId);

            connection.on("open", () => {
                connectionStatus.innerHTML = "Success";
            });
        }

        callButton.onclick = () => {
            navigator.mediaDevices.getUserMedia(mediaPermission)
            .then(stream => {

                // preview
                let senderVideo = document.querySelector('#sender');
                senderVideo.srcObject = stream;
                senderVideo.play();

                // Call
                let partnerPeerId = peerIdInputField.value.trim();
                let call = peer.call(partnerPeerId, stream);

                // backword
                call.on("stream", remoteSream => {
                    let receiverVideo = document.querySelector('#receiver');
                    receiverVideo.srcObject = remoteSream;
                    receiverVideo.play();
                });
            })
            .catch(error => {
                console.log(error);
            });
        }

        receiveButton.onclick = () => {
            peer.on("call", call => {
                navigator.mediaDevices.getUserMedia(mediaPermission)
                .then(stream => {
                    let senderVideo = document.querySelector('#sender');
                    senderVideo.srcObject = stream;
                    senderVideo.play();

                    call.answer(stream);

                    call.on("stream", remoteSream => {
                        let receiverVideo = document.querySelector('#receiver');
                        receiverVideo.srcObject = remoteSream;
                        receiverVideo.play();
                    });
                });
            });
        }

    </script>
</body>
</html>
